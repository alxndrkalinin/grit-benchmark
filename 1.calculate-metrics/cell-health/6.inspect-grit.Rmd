---
title: "Inspect Grit"
author: "Shantanu Singh"
output: 
  html_notebook:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: lumen
---

```
output: 
  html_notebook:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: lumen
```

```
output: github_document
```

# Boilerplate 

```{r echo=FALSE}
show_table <- print
```

If running interactively in RStudio, 

- change `output` in the header of this markdown to `html_notebook` and
- change to `eval=TRUE` below

When knitting for pushing to GitHub,

- change `output` in the header of this markdown to `github_document` and
- change to `eval=FALSE` below

```{r eval=FALSE}
show_table <- knitr::kable
knitr::opts_chunk$set(fig.width = 6, fig.asp = 2/3)
```


```{r message=FALSE}
library(magrittr)
library(tidyverse)
```


```{r}
source("../../R/cytominer-eval.R")
```

# Load data

Load EMPTY-normalized data

```{r message=FALSE}
profiles <- read_csv("data/cell_health_merged_feature_select.csv.gz")
```


```{r}
metadata <- get_annotation(profiles)
```


```{r}
head(metadata, 5)
```


# Calculate similarity

```{r}
sim_df <- sim_calculate(profiles)
```

# Replicate similarity

## Calculate

```{r}
grouping_cols <- c("Metadata_cell_line", "Metadata_gene_name", "Metadata_pert_name")

annotation_cols <- c("Metadata_cell_line", "Metadata_gene_name", "Metadata_pert_name")

rep <-
  sim_filter_groups(sim_df,
                    metadata,
                    grouping_cols,
                    annotation_cols,
                    drop_lower = TRUE)
```

## Check

```{r}
n_profiles <- 
  profiles %>%
  group_by(across(any_of(annotation_cols))) %>%
  tally(name = "n_profiles") %>%
  arrange(desc(n_profiles))

n_replicate_pairs <- 
  rep %>%
  group_by(across(any_of(annotation_cols))) %>%
  tally(name = "n_replicate_pairs") %>%
  arrange(desc(n_replicate_pairs))

inner_join(n_profiles, n_replicate_pairs) %>%
  mutate(check =
           n_replicate_pairs == (n_profiles * (n_profiles - 1)) / 2) %>%
  filter(!check)

```

# Reference similarity

## Calculate

```{r}
reference <- 
  data.frame(Metadata_gene_name = "EMPTY")

annotation_cols <- c("Metadata_cell_line", "Metadata_gene_name", "Metadata_pert_name")

grouping_cols <- c("Metadata_cell_line")

ref <-
  sim_filter_reference_within_group(
    sim_df,
    metadata,
    grouping_cols,
    reference,
    annotation_cols,
    filter_out_reference = TRUE
  )
```

## Check 

```{r}
n_reference_pairs <- 
  ref %>%
  group_by(across(any_of(annotation_cols))) %>%
  tally(name = "n_reference_pairs") %>%
  arrange(desc(n_reference_pairs))

n_references <-
  metadata %>%
  inner_join(reference) %>%
  group_by(across(any_of(annotation_cols))) %>%
  tally(name = "n_references")

inner_join(n_profiles, n_reference_pairs) %>%
  inner_join(n_references) %>%
  mutate(check =
           n_reference_pairs == (n_profiles * n_references)) %>%
  filter(!check)
```
# Inspect

```{r}
rep %>%
  filter(Metadata_gene_name != "EMPTY") %>%
  ggplot(aes(sim)) + 
  geom_histogram(binwidth = .1) + 
  facet_wrap(~Metadata_cell_line)
```

```{r}
ref %>%
  ggplot(aes(sim)) + 
  geom_histogram(binwidth = .1) + 
  facet_wrap(~Metadata_cell_line)
```
```{r}
rep %>% 
  filter(Metadata_gene_name == "EMPTY") %>%
  ggplot(aes(Metadata_cell_line, sim)) + 
  geom_boxplot() +
  ggtitle("Similarity of EMPTY to each other")

rep %>% 
  filter(Metadata_gene_name == "EMPTY") %>%
  group_by(Metadata_cell_line) %>%
  summarise(across(any_of("sim"), list(mean = mean, sd = sd)))
```


```{r}
annotation_cols <- c("Metadata_cell_line", "Metadata_gene_name", "Metadata_pert_name")

ref %>% 
  group_by(across(any_of(annotation_cols))) %>%
  summarise(across(any_of("sim"), list(mean = mean, sd = sd))) %>%
  pivot_longer(-any_of(annotation_cols)) %>%
  ggplot(aes(Metadata_cell_line, value)) + geom_boxplot() + 
  facet_wrap(~name) +
  ggtitle("Similarity of perturbations to EMPTY")

```

```{r}

grouping_cols <- c("Metadata_cell_line", "Metadata_gene_name", "Metadata_pert_name")

summary_sim_rep <-
  rep %>% 
  group_by(across(any_of(grouping_cols))) %>%
  summarise(sim_rep = quantile(sim, .75), .groups = "keep")
  
summary_sim_rep_ref <- 
  summary_sim_rep %>%
  ungroup() %>%
  inner_join(reference) %>%
  select(Metadata_cell_line, sim_ref_rep = sim_rep)

summary_sim_ref <-
  ref %>% 
  group_by(across(any_of(grouping_cols))) %>%
  summarise(sim_ref = quantile(sim, .75), .groups = "keep")
  
summary_sim <-
  inner_join(
    summary_sim_ref,
    summary_sim_rep
  ) %>%
  inner_join(summary_sim_rep_ref)
```
```{r}
ggplot(summary_sim, aes(sim_ref, sim_rep)) + geom_point() + facet_wrap(~Metadata_cell_line)
```

