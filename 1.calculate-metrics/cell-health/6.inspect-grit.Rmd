---
title: "Inspect Grit"
author: "Shantanu Singh"
output: 
  html_notebook:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: lumen
---

```
output: 
  html_notebook:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: lumen
```

```
output: github_document
```

# Boilerplate 

```{r echo=FALSE}
show_table <- print
```

If running interactively in RStudio, 

- change `output` in the header of this markdown to `html_notebook` and
- change to `eval=TRUE` below

When knitting for pushing to GitHub,

- change `output` in the header of this markdown to `github_document` and
- change to `eval=FALSE` below

```{r eval=FALSE}
show_table <- knitr::kable
knitr::opts_chunk$set(fig.width = 6, fig.asp = 2/3)
```


```{r message=FALSE}
library(magrittr)
library(tidyverse)
library(arrow)

```


```{r}
source("../../R/cytominer-eval.R")
```


# Load data

Load EMPTY-normalized data

```{r message=FALSE}
profiles <- read_csv("data/cell_health_merged_feature_select.csv.gz")
```


```{r}
metadata <- get_annotation(profiles)
```


```{r}
head(metadata, 5)
```



# Calculate similarity

```{r}
if (file.exists("data/sim.parquet")) {
  message("Loading existing similarity file...")
  sim_df <- arrow::read_parquet("data/sim.parquet")
    
} else {
  sim_df <- sim_calculate(profiles)
  sim_df %>% arrow::write_parquet("data/sim.parquet")
  
}
```

# Replicate similarity

## Calculate

```{r}
all_same_cols_rep <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

annotation_cols <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

rep <-
  sim_all_same(sim_df,
               metadata,
               all_same_cols_rep,
               annotation_cols,
               drop_lower = FALSE)

all_same_cols_rep_ref <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name",
    "Metadata_Plate")

filter_keep <-
  data.frame(Metadata_gene_name = "EMPTY")

rep_ref <-
  sim_df %>%
  sim_keep(metadata,
           filter_keep,
           "left") %>%
  sim_keep(metadata,
           filter_keep,
           "right") %>%
  sim_all_same(metadata,
               all_same_cols_rep_ref,
               annotation_cols = all_same_cols_rep_ref,
               drop_lower = FALSE)
```


## Check

```{r}
n_profiles <- 
  profiles %>%
  group_by(across(all_of(all_same_cols_rep))) %>%
  tally(name = "n_profiles") %>%
  arrange(desc(n_profiles))

n_replicate_pairs <- 
  rep %>%
  group_by(across(all_of(annotation_cols))) %>%
  tally(name = "n_replicate_pairs") %>%
  arrange(desc(n_replicate_pairs))

inner_join(n_profiles, n_replicate_pairs, by = all_same_cols_rep) %>%
  mutate(check =
           n_replicate_pairs == n_profiles * (n_profiles - 1)) %>%
  filter(!check)

```


# Reference similarity

## Calculate

```{r}
filter_keep <-
  data.frame(Metadata_gene_name = "EMPTY")

annotation_cols <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

all_same_cols_ref <-
  c("Metadata_cell_line",
    "Metadata_Plate")

annotation_cols <-
  unique(c(annotation_cols, all_same_cols_ref))

ref <-
  sim_all_same_keep_some(sim_df,
                         metadata,
                         all_same_cols_ref,
                         filter_keep_right = filter_keep,
                         annotation_cols)
```


## Check 

```{r}
all_same_cols_rep <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

all_same_cols_ref <-
  c("Metadata_cell_line", 
    "Metadata_Plate")

# number of profiles
n_profiles <- 
  profiles %>%
  group_by(across(all_of(c(all_same_cols_rep, all_same_cols_ref)))) %>%
  tally(name = "n_profiles") %>%
  arrange(desc(n_profiles))

# number of references
n_references <-
  metadata %>%
  inner_join(filter_keep, by = colnames(filter_keep)) %>%
  group_by(across(all_of(all_same_cols_ref))) %>%
  tally(name = "n_references")

# number of pairs involving the reference (on the right column)
n_reference_pairs <- 
  ref %>%
  group_by(across(all_of(c(all_same_cols_rep, all_same_cols_ref)))) %>%
  tally(name = "n_reference_pairs") %>%
  arrange(desc(n_reference_pairs))

# number of profiles x number of references = number of pairs involving the
# reference (on the right column)
check_df <- 
  n_references %>% 
  inner_join(n_reference_pairs, by = all_same_cols_ref) %>%
  inner_join(n_profiles, by = unique(c(all_same_cols_rep, all_same_cols_ref)))

check_df %>%
  mutate(check =
           n_reference_pairs == (n_profiles * n_references)) %>%
  filter(!check)
```



# Non-replicate similarity

## Calculate

```{r}

all_same_cols_rep <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

all_same_cols_ref <-
  c("Metadata_cell_line", 
    "Metadata_Plate")


any_different_cols_non_rep <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

all_same_cols_non_rep <-
  c("Metadata_cell_line", "Metadata_Plate")

all_different_cols_non_rep <-
  c("Metadata_gene_name")

annotation_cols <-
  c(
    "Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name",
    "Metadata_Plate",
    "Metadata_Well"
  )

filter_drop <-
  data.frame(Metadata_gene_name = "EMPTY")

nonrep <-
  sim_some_different_drop_some(
    sim_df,
    metadata,
    any_different_cols = any_different_cols_non_rep,
    all_same_cols = all_same_cols_non_rep,
    all_different_cols = all_different_cols_non_rep,
    filter_drop_left = filter_drop,
    filter_drop_right = filter_drop
  )
```


## Check

```{r}
nonrep_annotated <-
  nonrep %>%
  sim_annotate(metadata, annotation_cols, index = "both")

walk(all_same_cols_non_rep,
     function(x) {
       x1 <- paste0(x, "1")
       x2 <- paste0(x, "2")
       # by definition of all_same_cols
       stopifnot(nonrep_annotated %>% filter(.data[[x1]] != .data[[x2]]) %>% nrow() == 0)
     })


walk(all_different_cols_non_rep,
     function(x) {
       x1 <- paste0(x, "1")
       x2 <- paste0(x, "2")
       # by definition of all_different_cols
       stopifnot(nonrep_annotated %>% filter(.data[[x1]] == .data[[x2]]) %>% nrow() == 0)
     })

# by definition of any_different_cols
# any_different is identical to not_all_same
stopifnot(
  nonrep_annotated %>%
    unite(
      "any_different_col1",
      all_of(paste0(any_different_cols_non_rep, "1")),
      sep = ":",
      remove = FALSE
    ) %>%
    unite(
      "any_different_col2",
      all_of(paste0(any_different_cols_non_rep, "2")),
      sep = ":",
      remove = FALSE
    ) %>%
    filter(any_different_col1 == any_different_col2) %>%
    nrow() == 0
)
```



# Inspect

## Similarity among replicates

```{r}
rep %>%
  filter(Metadata_gene_name != "EMPTY") %>%
  ggplot(aes(sim)) + 
  geom_histogram(binwidth = .1) + 
  facet_wrap(~Metadata_cell_line) +
  ggtitle("Similarity of perturbations to each other", subtitle = "(EMPTY are dropped)")

```

## Similarity among reference wells


```{r}
rep_ref %>% 
  ggplot(aes(Metadata_cell_line, sim)) + 
  geom_boxplot() +
  ggtitle("Similarity of EMPTY wells")

rep_ref %>% 
  group_by(Metadata_cell_line) %>%
  summarise(across(all_of("sim"), list(mean = mean, sd = sd)))
```

## Similarity between perturbation wells and reference wells

```{r}
ref %>%
  ggplot(aes(sim)) + 
  geom_histogram(binwidth = .1) + 
  facet_wrap(~Metadata_cell_line) +
  ggtitle("Similarity of EMPTY wells")
```

```{r}
annotation_cols <- c("Metadata_cell_line", "Metadata_gene_name", "Metadata_pert_name")

ref %>% 
  group_by(across(all_of(annotation_cols))) %>%
  summarise(across(all_of("sim"), list(mean = mean, sd = sd))) %>%
  pivot_longer(-any_of(annotation_cols)) %>%
  ggplot(aes(Metadata_cell_line, value)) + geom_boxplot() + 
  facet_wrap(~name) +
  ggtitle("Similarity of perturbations to EMPTY")

```
## Compare similarities 

```{r}
q <- .5
qs <- sprintf("%02d", q * 100)

# summarize similarity among replicates
sum_rep <-
  rep %>% 
  group_by(across(all_of(all_same_cols_rep))) %>%
  summarise(sim_rep_q = quantile(sim, q), .groups = "keep") %>%
  ungroup()

# summarize similarity to reference wells
sum_ref <-
  ref %>% 
  group_by(across(all_of(all_same_cols_rep))) %>%
  summarise(sim_ref_q = quantile(sim, q), .groups = "keep")
  
# summarize similarity among replicates of reference wells
sum_rep_ref <-
  rep_ref %>% 
  group_by(across(all_of(all_same_cols_rep_ref))) %>%
  summarise(sim_rep_ref_q = quantile(sim, q), .groups = "keep") %>%
  ungroup() %>%
  group_by(across(all_of(intersect(all_same_cols_ref, all_same_cols_rep)))) %>%
  summarise(sim_rep_ref_q_mean = mean(sim_rep_ref_q), .groups = "keep") %>%
  ungroup()
  
sum_all <-
  sum_ref %>%
  inner_join(sum_rep) %>%
  inner_join(sum_rep_ref)
```


```{r}
library(glue)

ggplot(sum_all, aes(sim_ref_q, sim_rep_q)) + 
  geom_point() + 
  geom_vline(aes(xintercept = sim_rep_ref_q_mean)) +
  facet_wrap(~Metadata_cell_line) +
  xlab(glue("q{qs} similarity to EMPTY")) +
  ylab(glue("q{qs} pairwise replicate similarity")) +
  ggtitle("Replicate similarity vs. similarity to EMPTY", 
          subtitle = glue("Vertical line is q{qs} of EMPTY replicate similarity"))
```

## Inspect non-replicates

```{r}
all_same_cols_rep <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

tally_cols <- c(all_same_cols_rep, "Metadata_Plate", "Metadata_Well")
tally_cols <- paste0(tally_cols, "1")

nonrep_annotated %>%
  group_by(across(all_of(tally_cols))) %>%
  tally() %>%
  head()
```
# Combine

For every well, we have a distribution of
1. similarity to replicates (same perturbation, same cell line)
1. similarity to replicates for EMPTY wells (same cell line, same plate)
2. similarity to EMPTY wells (same cell line, same plate)
3. simialrity to non-replicates (same cell line, same plate)

Let's arrange all this into a single data frame

```{r}
nonrep1 <- 
  nonrep %>%
  sim_annotate(metadata, all_same_cols_rep, index = "left") %>%
  mutate(type = "nonrep") %>%
  arrange(id1)

ref1 <- 
  ref %>%
  select(-all_of(setdiff(all_same_cols_ref, all_same_cols_rep))) %>%
  mutate(type = "ref") %>%
  arrange(id1)

rep1 <-
  rep %>%
  anti_join(filter_keep) %>%
  mutate(type = "rep") %>%
  arrange(id1)

rep_ref1 <-
  rep_ref %>%
  select(-all_of(setdiff(all_same_cols_ref, all_same_cols_rep))) %>%
  mutate(type = "rep") %>%
  arrange(id1)


head(rep1)
head(rep_ref1)
head(nonrep1)
head(ref1)
```


```{r}
all_sim <-
  bind_rows(
    rep1,
    rep_ref1,
    nonrep1,
    ref1
  ) %>%
  distinct() %>%
  group_by(across(all_of(c("id1", all_same_cols_rep, "type")))) %>%
  tally() %>%
  arrange(across(all_of(all_same_cols_rep))) %>%
  pivot_wider(names_from = "type",
              values_from = n,
              values_fill = 0)
```



# Recompute

```{r}
rm(list = ls())
```

## Libraries

```{r}
library(magrittr)
library(tidyverse)
library(arrow)
source("../../R/cytominer-eval.R")
```

## Load data

```{r message=FALSE}
profiles <- read_csv("data/cell_health_merged_feature_select.csv.gz")

metadata <- get_annotation(profiles)
```


```{r}
if (file.exists("data/sim.parquet")) {
  message("Loading existing similarity file...")
  sim_df <- arrow::read_parquet("data/sim.parquet")
    
} else {
  sim_df <- sim_calculate(profiles)
  sim_df %>% arrow::write_parquet("data/sim.parquet")
  
}
```

## Compute similarity sets

```{r}

# ---- 0. Filter out some rows ----

drop_group <-
  data.frame(Metadata_gene_name = "EMPTY")

# ---- 1. Similarity to reference ---- 

# Measure similarities of 
# a. all rows except those containing `reference`
# to 
# a. all rows containing `reference`
# Do so only for those (a, b) pairs that 
# - have *same* values in *all* columns of `all_same_cols_ref`
    
reference <-
  data.frame(Metadata_gene_name = c("Chr2", "Luc", "LacZ"))

all_same_cols_rep_ref <-
  c(
    "Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name",
    "Metadata_Plate"
  )

# ---- 2. Similarity among replicates ----

# Measure similarities of 
# a. all rows except `reference` rows
# to
# b. all rows except `reference` rows (i.e. to each other)
# 
# Do so for only those (a, b) pairs that 
# - have *same* values in *all* columns of `all_same_cols_rep
# 
# Keep, both, (a, b) and (b, a)

all_same_cols_rep <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")


# ---- 3. Similarity among reference replicates ----

# Measure similarities of 
# a. all rows containing `reference`
# to
# b. all rows containing `reference` (i.e. to each other)
# 
# Do so for only those (a, b) pairs that 
# - have *same* values in *all* columns of `all_same_cols_rep_ref`. 
# 
# Keep, both, (a, b) and (b, a)

all_same_cols_ref <-
  c("Metadata_cell_line",
    "Metadata_Plate")

# ---- 4. Similarity among non-replicates ----

# Measure similarities of 
# a. all rows except `reference` rows
# to
# b. all rows except `reference` rows (i.e. to each other)
# 
# Do so for only those (a, b) pairs that 
# - have *same* values in *all* columns of `all_same_cols_non_rep`
# - have *different* values in *all* columns `all_different_cols_non_rep`
# - have *different* values in *at least one* column of `any_different_cols_non_rep`
# 
# Keep, both, (a, b) and (b, a)

any_different_cols_non_rep <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

all_same_cols_non_rep <-
  c("Metadata_cell_line", 
    "Metadata_Plate")

all_different_cols_non_rep <-
  c("Metadata_gene_name")

# ---- 5. Combine 1-4 and annotate the similarity matrix ----

annotation_cols <-
  c("Metadata_cell_line",
    "Metadata_gene_name",
    "Metadata_pert_name")

all_sim <-
  sim_munge(
    sim_df,
    metadata,
    reference,
    all_same_cols_rep = all_same_cols_rep,
    all_same_cols_rep_ref = all_same_cols_rep_ref,
    all_same_cols_ref = all_same_cols_ref,
    any_different_cols_non_rep = any_different_cols_non_rep,
    all_same_cols_non_rep = all_same_cols_non_rep,
    all_different_cols_non_rep = all_different_cols_non_rep,
    annotation_cols = annotation_cols,
    drop_group = drop_group
  )

```


```{r}
# check for duplicates 
stopifnot(
  all_sim %>%
    unite("id12", all_of(c("id1", "id2")), sep = ":") %>%
    pull("id12") %>%
    duplicated() %>%
    any() %>%
    not()
)

all_sim_counts <-
  all_sim %>%
  group_by(across(all_of(c("id1", all_same_cols_rep, "type")))) %>%
  tally() %>%
  arrange(across(all_of(all_same_cols_rep))) %>%
  pivot_wider(names_from = "type",
              values_from = n,
              values_fill = 0)

all_sim_counts %>%
  group_by(nonrep) %>%
  tally(name = "n_perts")

all_sim_counts %>%
  group_by(rep) %>%
  tally(name = "n_perts")

all_sim_counts %>%
  group_by(ref) %>%
  tally(name = "n_perts")
```


```{r}
ref_stats <- 
  all_sim %>%
  filter(type == "ref") %>%
  group_by(across(all_of(c("id1", all_same_cols_rep)))) %>%
  summarise(across(all_of("sim"), list(mean = mean, sd = sd)), .groups = "keep") %>%
  ungroup() %>%
  select(id1, sim_mean, sim_sd)

norm_ref <-
  all_sim %>%
  filter(type == "rep") %>%
  inner_join(ref_stats, by = c("id1")) %>%
  mutate(sim_norm_ref = (sim - sim_mean) / sim_sd)
  
norm_ref_counts <- 
  norm_ref %>%
  group_by(across(all_of(c("id1", all_same_cols_rep)))) %>%
  arrange(across(all_of(all_same_cols_rep))) %>%
  tally()

norm_ref_aggregated <-
  norm_ref %>%
  group_by(across(all_of(c("id1", all_same_cols_rep)))) %>%
  summarise(across(all_of(c("sim_norm_ref", "sim")), list(median = median)), .groups = "keep")
```


```{r}
nonrep_stats <- 
  all_sim %>%
  filter(type == "nonrep") %>%
  group_by(across(all_of(c("id1", all_same_cols_rep)))) %>%
  summarise(across(all_of("sim"), list(mean = mean, sd = sd)), .groups = "keep") %>%
  ungroup() %>%
  select(id1, sim_mean, sim_sd)

norm_nonrep <-
  all_sim %>%
  filter(type == "rep") %>%
  inner_join(nonrep_stats, by = c("id1")) %>%
  mutate(sim_norm_nonrep = (sim - sim_mean) / sim_sd)
  
norm_nonrep_counts <- 
  norm_nonrep %>%
  group_by(across(all_of(c("id1", all_same_cols_rep)))) %>%
  arrange(across(all_of(all_same_cols_rep))) %>%
  tally()

norm_nonrep_aggregated <-
  norm_nonrep %>%
  group_by(across(all_of(c("id1", all_same_cols_rep)))) %>%
  summarise(across(all_of(c("sim_norm_nonrep", "sim")), list(median = median)), .groups = "keep")
```


```{r}
norm_nonrep_ref_aggregated <-
  inner_join(
    norm_nonrep_aggregated,
    norm_ref_aggregated
  )
```

```{r}
ggplot(norm_nonrep_ref_aggregated, 
       aes(sim_norm_ref_median, sim_median)) + 
  geom_point() + 
  geom_smooth(method = "lm",
              formula = "y ~ x")
```


```{r}
ggplot(norm_nonrep_ref_aggregated, 
       aes(sim_norm_nonrep_median, sim_median)) + 
  geom_point() + 
  geom_smooth(method = "lm",
              formula = "y ~ x")
```
```{r}
ggplot(norm_nonrep_ref_aggregated, 
       aes(sim_norm_nonrep_median, sim_norm_ref_median)) + 
  geom_point() + 
  geom_smooth(method = "lm",
              formula = "y ~ x")
```

